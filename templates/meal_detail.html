{% extends "layout.html" %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='restaurant_detail.css') }}">
{% endblock %}

{% block content %}
<div class="restaurant-detail-wrapper">

  <button onclick="goBack()" class="back-button">
    <i class="fas fa-arrow-left"></i> Back
  </button>

  <div class="restaurant-header">
    <div class="restaurant-details">
      <h1>{{ meal.title }}</h1>
      <div class="rating-price-cuisine-vibe">
        <span class="price">üí∞ About ${{ "%.2f"|format(meal.price) }} per serving</span>
        {% if meal.get('meal_type') %}
          <span class="price">üçΩÔ∏è {{ meal.meal_type }}</span>
        {% endif %}
        <button class="heart-btn-inline"
            data-name="{{ meal.title }}"
            data-url="{{ meal.source_url }}">
          {% if meal.get('loved') %}
            <i class="fas fa-heart" style="color: red;"></i>
          {% else %}
            <i class="far fa-heart"></i>
          {% endif %}
        </button>
      </div>
      <p>{{ meal.summary }}</p>
      <div class="action-buttons">
        <a href="{{ meal.source_url }}" target="_blank" class="yelp-btn">
          <i class="fas fa-external-link-alt"></i> View Source
        </a>
      </div>
    </div>
  </div>

<div class="detail-wrapper">
  <div class="detail-card">
    <h3>Ingredients</h3>
    {% if ingredients %}
      <ul>
        {% for item in ingredients %}
          <li>{{ item }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p><em>No ingredients available.</em></p>
    {% endif %}
  </div>

  <div class="detail-card">
    <h3>Step‚Äëby‚Äëstep Instructions</h3>
    {% if instructions %}
      <ol>
        {% for step in instructions %}
          <li>{{ step }}</li>
        {% endfor %}
      </ol>
    {% else %}
      <p><em>No instructions available.</em></p>
    {% endif %}
  </div>
</div>

  <div class="restaurant-notes">
    <h3><i class="fas fa-sticky-note"></i> My Notes</h3>
    
    <!-- Display existing notes if they exist -->
    {% if current_notes %}
    <div class="current-notes-display" id="notesDisplay">
      <div class="notes-content">
        <p>{{ current_notes }}</p>
      </div>
      <div class="notes-actions">
        <button onclick="editNotes()" class="edit-notes-btn">
          <i class="fas fa-edit"></i> Edit Notes
        </button>
        <button onclick="deleteNotes()" class="delete-notes-btn">
          <i class="fas fa-trash"></i> Delete Notes
        </button>
      </div>
    </div>
    {% endif %}
    
    <!-- Notes editor (hidden by default if notes exist) -->
    <div class="notes-editor" id="notesEditor" style="display: none;">
      <textarea 
        id="notesTextarea" 
        placeholder="Add your personal notes about this recipe...&#10;&#10;Examples:&#10;‚Ä¢ Made with extra garlic - delicious!&#10;‚Ä¢ Takes longer than expected, plan ahead&#10;‚Ä¢ Kids loved it, make again&#10;‚Ä¢ Too spicy, reduce pepper next time"
        maxlength="500">{{ current_notes or '' }}</textarea>
      
      <div class="notes-actions">
        <button onclick="saveNotes()" class="save-notes-btn">
          <i class="fas fa-save"></i> Save Notes
        </button>
        {% if current_notes %}
        <button onclick="cancelEdit()" class="cancel-notes-btn">
          <i class="fas fa-times"></i> Cancel
        </button>
        {% endif %}
      </div>
      
      <div class="character-count">
        <span id="charCount">{{ current_notes|length if current_notes else 0 }}</span>/500 characters
      </div>
    </div>
    
    <!-- If no notes exist, show add button -->
    {% if not current_notes %}
    <div class="no-notes-state" id="noNotesState">
      <p class="no-notes-text">
        <i class="fas fa-lightbulb"></i> 
        Keep track of your thoughts about this recipe - modifications you made, cooking tips, family reactions, or anything you want to remember for next time.
      </p>
      <button onclick="showNotesEditor()" class="add-notes-btn">
        <i class="fas fa-plus"></i> Add Personal Notes
      </button>
    </div>
    {% endif %}
    
    <!-- Loading/saving state -->
    <div class="notes-status" id="notesStatus" style="display: none;">
      <i class="fas fa-spinner fa-spin"></i> <span id="statusText">Saving...</span>
    </div>
  </div>

</div>

<script>
// Meal data for API calls
const mealTitle = "{{ meal.title }}";

document.addEventListener('click', function(e) {
  const button = e.target.closest('.heart-btn-inline');
  if (button && button.dataset.name && button.dataset.url) {
    const name = button.dataset.name;
    const url = button.dataset.url;

    button.disabled = true;
    button.style.opacity = '0.6';

    fetch('/love_meal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, url })
    })
    .then(res => res.json())
    .then(data => {
      button.innerHTML = data.loved
        ? '<i class="fas fa-heart" style="color: red;"></i>'
        : '<i class="far fa-heart"></i>';
    })
    .catch(err => {
      console.error('Error updating love status:', err);
      alert('Failed to update favorite. Please try again.');
    })
    .finally(() => {
      button.disabled = false;
      button.style.opacity = '1';
    });
  }
});


// Initialize character counter on page load
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('notesTextarea');
    const charCount = document.getElementById('charCount');
    
    if (textarea && charCount) {
        // Update character count on input
        textarea.addEventListener('input', function() {
            const count = this.value.length;
            charCount.textContent = count;
            
            // Change color when approaching limit
            if (count > 450) {
                charCount.style.color = '#dc3545';
            } else if (count > 400) {
                charCount.style.color = '#fd7e14';
            } else {
                charCount.style.color = '#666';
            }
        });
    }
});

function showNotesEditor() {
    document.getElementById('noNotesState').style.display = 'none';
    document.getElementById('notesEditor').style.display = 'block';
    document.getElementById('notesTextarea').focus();
}

function editNotes() {
    document.getElementById('notesDisplay').style.display = 'none';
    document.getElementById('notesEditor').style.display = 'block';
    document.getElementById('notesTextarea').focus();
}

function cancelEdit() {
    // Reset textarea to original value
    const textarea = document.getElementById('notesTextarea');
    const originalNotes = "{{ current_notes or '' }}";
    textarea.value = originalNotes;
    
    // Update character count
    document.getElementById('charCount').textContent = originalNotes.length;
    
    // Show display, hide editor
    document.getElementById('notesEditor').style.display = 'none';
    
    {% if current_notes %}
    document.getElementById('notesDisplay').style.display = 'block';
    {% else %}
    document.getElementById('noNotesState').style.display = 'block';
    {% endif %}
}

function saveNotes() {
    const textarea = document.getElementById('notesTextarea');
    const notes = textarea.value.trim();
    
    // Show saving status
    showStatus('Saving...', true);
    
    fetch('/update_meal_notes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: mealTitle,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Saved successfully!', false);
            
            // Update the page to show the new notes
            if (notes.length > 0) {
                updateNotesDisplay(notes);
                document.getElementById('notesEditor').style.display = 'none';
                document.getElementById('notesDisplay').style.display = 'block';
                document.getElementById('noNotesState').style.display = 'none';
            } else {
                // If notes were cleared, show no notes state
                document.getElementById('notesEditor').style.display = 'none';
                document.getElementById('notesDisplay').style.display = 'none';
                document.getElementById('noNotesState').style.display = 'block';
            }
            
            // Hide status after 2 seconds
            setTimeout(() => {
                document.getElementById('notesStatus').style.display = 'none';
            }, 2000);
            
        } else {
            throw new Error(data.error || 'Failed to save notes');
        }
    })
    .catch(error => {
        console.error('Error saving notes:', error);
        showStatus('Error saving notes. Please try again.', false);
        setTimeout(() => {
            document.getElementById('notesStatus').style.display = 'none';
        }, 3000);
    });
}

function deleteNotes() {
    if (confirm('Are you sure you want to delete your notes for this recipe?')) {
        // Clear the textarea and save
        document.getElementById('notesTextarea').value = '';
        saveNotes();
    }
}

function updateNotesDisplay(notes) {
    const notesContent = document.querySelector('.notes-content p');
    if (notesContent) {
        notesContent.textContent = notes;
    } else {
        // Create the notes display if it doesn't exist
        const notesSection = document.querySelector('.restaurant-notes');
        const notesDisplay = document.createElement('div');
        notesDisplay.className = 'current-notes-display';
        notesDisplay.id = 'notesDisplay';
        notesDisplay.innerHTML = `
            <div class="notes-content">
                <p>${notes}</p>
            </div>
            <div class="notes-actions">
                <button onclick="editNotes()" class="edit-notes-btn">
                    <i class="fas fa-edit"></i> Edit Notes
                </button>
                <button onclick="deleteNotes()" class="delete-notes-btn">
                    <i class="fas fa-trash"></i> Delete Notes
                </button>
            </div>
        `;
        
        // Insert after the h3
        const h3 = notesSection.querySelector('h3');
        h3.parentNode.insertBefore(notesDisplay, h3.nextSibling);
    }
}

function showStatus(message, isLoading) {
    const statusDiv = document.getElementById('notesStatus');
    const statusText = document.getElementById('statusText');
    const spinner = statusDiv.querySelector('i');
    
    statusText.textContent = message;
    statusDiv.style.display = 'block';
    
    if (isLoading) {
        spinner.className = 'fas fa-spinner fa-spin';
        statusDiv.style.color = '#ACB288';
    } else {
        spinner.className = 'fas fa-check';
        statusDiv.style.color = '#28a745';
    }
}

// Smart back navigation
function goBack() {
    const source = "{{ source }}";
    
    if (source === 'prep-search-history') {
        // Go back to my_recommendations with meals tab and search history active
        window.location.href = "{{ url_for('my_recommendations') }}#prep-search-history";
    } else if (source === 'prep-loved') {
        // Go back to my_recommendations with meals tab and loved active  
        window.location.href = "{{ url_for('my_recommendations') }}#prep-loved";
    } else {
        // Default: go back to prep form (coming from fresh meal generation)
        history.back();
    }
}
</script>
{% endblock %}