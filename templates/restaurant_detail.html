{% extends "layout.html" %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='restaurant_detail.css') }}">

<div class="restaurant-detail-wrapper">
  <button onclick="history.back()" class="back-button">
    <i class="fas fa-arrow-left"></i> Back
  </button>
  
  <div class="restaurant-header">
    <div class="restaurant-info">
      <div class="restaurant-image">
        <img src="{{ restaurant.image_url }}" alt="{{ restaurant.name }}"
             onerror="this.onerror=null;this.src='https://st4.depositphotos.com/14953852/24787/v/450/depositphotos_247872612-stock-illustration-no-image-available-icon-vector.jpg';">
      </div>
      
      <div class="restaurant-details">
        <h1>{{ restaurant.name }}</h1>
        <p class="location"><i class="fas fa-map-marker-alt"></i> {{ restaurant.location }}</p>
        <div class="rating-price-cuisine-vibe">
          <span class="rating"><i class="fas fa-star"></i> {{ restaurant.rating }}</span>
          <span class="price">{{ restaurant.price }}</span>
          <span class="price">{{ restaurant.cuisine }}</span>
          <span class="price">{{ restaurant.vibe }}</span>
          <button class="heart-btn-inline" 
            data-name="{{ restaurant.name }}"
            data-location="{{ restaurant.location }}">
            {% if restaurant.loved %}
            <i class="fas fa-heart" style="color: red;"></i>
            {% else %}
            <i class="far fa-heart"></i>
            {% endif %}
          </button>
        </div>
        
        <div class="action-buttons">
          <a href="{{ restaurant.url }}" target="_blank" class="yelp-btn">
            <i class="fab fa-yelp"></i> View on Yelp
          </a>
          <a href="https://www.google.com/maps/search/?api=1&query={{ maps_query | urlencode }}" 
             target="_blank" class="maps-btn">
            <i class="fas fa-map"></i> Open in Google Maps
          </a>
        </div>
      </div>
    </div>
  </div>

  {% if restaurant.blurb %}
  <div class="restaurant-description">
    <h3><i class="fas fa-info-circle"></i> About This Place</h3>
    <p>{{ restaurant.blurb }}</p>
  </div>
  {% endif %}

  <div class="restaurant-map">
    <h3><i class="fas fa-map-marker-alt"></i> Location</h3>
    <div class="map-container">
      <iframe 
        src="https://maps.google.com/maps?q={{ (restaurant.name + ' ' + restaurant.location) | urlencode }}&output=embed"
        width="100%" 
        height="500" 
        style="border:0;" 
        allowfullscreen="" 
        loading="lazy" 
        referrerpolicy="no-referrer-when-downgrade">
      </iframe>
    </div>
  </div>

  <div class="restaurant-notes">
    <h3><i class="fas fa-sticky-note"></i> My Notes</h3>
    
    <!-- Display existing notes if they exist -->
    {% if current_notes %}
    <div class="current-notes-display" id="notesDisplay">
      <div class="notes-content">
        <p>{{ current_notes }}</p>
      </div>
      <div class="notes-actions">
        <button onclick="editNotes()" class="edit-notes-btn">
          <i class="fas fa-edit"></i> Edit Notes
        </button>
        <button onclick="deleteNotes()" class="delete-notes-btn">
          <i class="fas fa-trash"></i> Delete Notes
        </button>
      </div>
    </div>
    {% endif %}
    
    <!-- Notes editor (hidden by default if notes exist) -->
    <div class="notes-editor" id="notesEditor" style="display: none;">
      <textarea 
        id="notesTextarea" 
        placeholder="Add your personal notes about this restaurant...&#10;&#10;Examples:&#10;• Great pasta, ask for extra sauce&#10;• Too noisy for dates, better for groups&#10;• Parking available behind building&#10;• Service was slow but food excellent"
        maxlength="500">{{ current_notes or '' }}</textarea>
      
      <div class="notes-actions">
        <button onclick="saveNotes()" class="save-notes-btn">
          <i class="fas fa-save"></i> Save Notes
        </button>
        {% if current_notes %}
        <button onclick="cancelEdit()" class="cancel-notes-btn">
          <i class="fas fa-times"></i> Cancel
        </button>
        {% endif %}
      </div>
      
      <div class="character-count">
        <span id="charCount">{{ current_notes|length if current_notes else 0 }}</span>/500 characters
      </div>
    </div>
    
    <!-- If no notes exist, show add button -->
    {% if not current_notes %}
    <div class="no-notes-state" id="noNotesState">
      <p class="no-notes-text">
        <i class="fas fa-lightbulb"></i> 
        Keep track of your thoughts about this restaurant - favorite dishes, parking tips, atmosphere notes, or anything you want to remember for next time.
      </p>
      <button onclick="showNotesEditor()" class="add-notes-btn">
        <i class="fas fa-plus"></i> Add Personal Notes
      </button>
    </div>
    {% endif %}
    
    <!-- Loading/saving state -->
    <div class="notes-status" id="notesStatus" style="display: none;">
      <i class="fas fa-spinner fa-spin"></i> <span id="statusText">Saving...</span>
    </div>
  </div>

</div>

<script>
// Event delegation for all heart buttons
document.addEventListener('click', function(e) {
    if (e.target.closest('.heart-btn-inline')) {
        e.preventDefault();
        const button = e.target.closest('.heart-btn-inline');
        const name = button.getAttribute('data-name');
        const location = button.getAttribute('data-location');
        
        if (name && location) {
            toggleRestaurantLove(name, location, button);
        }
    }
});

function toggleRestaurantLove(name, location, button) {
    console.log('Toggling love for:', name, 'at', location);
    
    // Visual feedback
    button.style.opacity = '0.5';
    button.disabled = true;
    
    fetch('/love_restaurant', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, location: location })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Server response:', data);
        
        if (data.loved) {
            button.innerHTML = '<i class="fas fa-heart" style="color: red;"></i>';
        } else {
            button.innerHTML = '<i class="far fa-heart"></i>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update favorite. Please try again.');
    })
    .finally(() => {
        button.style.opacity = '1';
        button.disabled = false;
    });
}
</script>

<script>
// Restaurant data for API calls
const restaurantName = "{{ restaurant.name }}";
const restaurantLocation = "{{ restaurant.location }}";

// Initialize character counter on page load
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('notesTextarea');
    const charCount = document.getElementById('charCount');
    
    if (textarea && charCount) {
        // Update character count on input
        textarea.addEventListener('input', function() {
            const count = this.value.length;
            charCount.textContent = count;
            
            // Change color when approaching limit
            if (count > 450) {
                charCount.style.color = '#dc3545';
            } else if (count > 400) {
                charCount.style.color = '#fd7e14';
            } else {
                charCount.style.color = '#666';
            }
        });
    }
});

function showNotesEditor() {
    document.getElementById('noNotesState').style.display = 'none';
    document.getElementById('notesEditor').style.display = 'block';
    document.getElementById('notesTextarea').focus();
}

function editNotes() {
    document.getElementById('notesDisplay').style.display = 'none';
    document.getElementById('notesEditor').style.display = 'block';
    document.getElementById('notesTextarea').focus();
}

function cancelEdit() {
    // Reset textarea to original value
    const textarea = document.getElementById('notesTextarea');
    const originalNotes = "{{ current_notes or '' }}";
    textarea.value = originalNotes;
    
    // Update character count
    document.getElementById('charCount').textContent = originalNotes.length;
    
    // Show display, hide editor
    document.getElementById('notesEditor').style.display = 'none';
    
    {% if current_notes %}
    document.getElementById('notesDisplay').style.display = 'block';
    {% else %}
    document.getElementById('noNotesState').style.display = 'block';
    {% endif %}
}

function saveNotes() {
    const textarea = document.getElementById('notesTextarea');
    const notes = textarea.value.trim();
    
    // Show saving status
    showStatus('Saving...', true);
    
    fetch('/update_restaurant_notes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: restaurantName,
            location: restaurantLocation,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Saved successfully!', false);
            
            // Update the page to show the new notes
            if (notes.length > 0) {
                updateNotesDisplay(notes);
                document.getElementById('notesEditor').style.display = 'none';
                document.getElementById('notesDisplay').style.display = 'block';
                document.getElementById('noNotesState').style.display = 'none';
            } else {
                // If notes were cleared, show no notes state
                document.getElementById('notesEditor').style.display = 'none';
                document.getElementById('notesDisplay').style.display = 'none';
                document.getElementById('noNotesState').style.display = 'block';
            }
            
            // Hide status after 2 seconds
            setTimeout(() => {
                document.getElementById('notesStatus').style.display = 'none';
            }, 2000);
            
        } else {
            throw new Error(data.error || 'Failed to save notes');
        }
    })
    .catch(error => {
        console.error('Error saving notes:', error);
        showStatus('Error saving notes. Please try again.', false);
        setTimeout(() => {
            document.getElementById('notesStatus').style.display = 'none';
        }, 3000);
    });
}

function deleteNotes() {
    if (confirm('Are you sure you want to delete your notes for this restaurant?')) {
        // Clear the textarea and save
        document.getElementById('notesTextarea').value = '';
        saveNotes();
    }
}

function updateNotesDisplay(notes) {
    const notesContent = document.querySelector('.notes-content p');
    if (notesContent) {
        notesContent.textContent = notes;
    } else {
        // Create the notes display if it doesn't exist
        const notesSection = document.querySelector('.restaurant-notes');
        const notesDisplay = document.createElement('div');
        notesDisplay.className = 'current-notes-display';
        notesDisplay.id = 'notesDisplay';
        notesDisplay.innerHTML = `
            <div class="notes-content">
                <p>${notes}</p>
            </div>
            <div class="notes-actions">
                <button onclick="editNotes()" class="edit-notes-btn">
                    <i class="fas fa-edit"></i> Edit Notes
                </button>
                <button onclick="deleteNotes()" class="delete-notes-btn">
                    <i class="fas fa-trash"></i> Delete Notes
                </button>
            </div>
        `;
        
        // Insert after the h3
        const h3 = notesSection.querySelector('h3');
        h3.parentNode.insertBefore(notesDisplay, h3.nextSibling);
    }
}

function showStatus(message, isLoading) {
    const statusDiv = document.getElementById('notesStatus');
    const statusText = document.getElementById('statusText');
    const spinner = statusDiv.querySelector('i');
    
    statusText.textContent = message;
    statusDiv.style.display = 'block';
    
    if (isLoading) {
        spinner.className = 'fas fa-spinner fa-spin';
        statusDiv.style.color = '#ACB288';
    } else {
        spinner.className = 'fas fa-check';
        statusDiv.style.color = '#28a745';
    }
}
</script>

{% endblock %}