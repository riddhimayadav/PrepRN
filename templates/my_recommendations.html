{% extends "layout.html" %}

{% block content %}
  <!-- Link to the recommendations-specific CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='my_recommendations.css') }}">

  <h2>Your Saved Recommendations</h2>

  <!-- Main tabs for toggling between restaurant and meal results -->
    <div class="main-tab-buttons">
    <button class="main-tab-button active" onclick="showMainTab('foodies')">üçΩÔ∏è Restaurants</button>
    <button class="main-tab-button" onclick="showMainTab('prep')">ü•ó Meals</button>
    </div>

  <!-- FoodiesRN saved results section -->
    <div id="foodies" class="main-tab-content">
    <!-- Sub-tabs for restaurants -->
    <div class="sub-tab-buttons">
        <button class="sub-tab-button active" onclick="showSubTab('foodies', 'search-history')">Search History</button>
        <button class="sub-tab-button" onclick="showSubTab('foodies', 'loved')">Liked</button>
    </div>

    <!-- Search History Sub-tab -->
    <div id="foodies-search-history" class="sub-tab-content">
        <div class="card-section">
        <div class="section-header">
            <!-- Button to clear all saved restaurant results -->
            <form method="POST" action="{{ url_for('clear_foodiesrn') }}">
            <button type="submit">Clear All Search History</button>
            </form>
        </div>

      {% if foodiesrn_results %}
        <div class="card-container">
          {% for r in foodiesrn_results %}
            <div class="card restaurant-card" data-restaurant-name="{{ r.name }}" data-restaurant-location="{{ r.location }}">
              <img src="{{ r.image_url }}" alt="Restaurant Image" class="card-img"
                onerror="this.onerror=null;this.src='https://st4.depositphotos.com/14953852/24787/v/450/depositphotos_247872612-stock-illustration-no-image-available-icon-vector.jpg';">
              
              <div class="card-content">
                <strong>{{ r.name }}</strong><br>
                <span class="location"><i class="fas fa-map-marker-alt"></i> {{ r.location }}</span><br>
                <div class="rating-price-inline">
                    <span class="rating">‚≠ê {{ r.rating }}</span>
                    <span class="price">üí≤{{ r.price }}</span>
                    <button class="heart-btn-inline" 
                        data-name="{{ r.name }}"
                        data-location="{{ r.location }}">
                        {% if r.loved %}
                        <i class="fas fa-heart" style="color: red;"></i>
                        {% else %}
                        <i class="far fa-heart"></i>
                        {% endif %}
                    </button>
                    <button class="delete-btn-inline" 
                        data-name="{{ r.name }}"
                        data-location="{{ r.location }}"
                        title="Delete from search history">
                        <i class="fas fa-trash-alt" style="color: #dc3545;"></i>
                    </button>
                    </div>

                    <div class="restaurant-actions">
                    <a href="{{ url_for('restaurant_detail', restaurant_name=r.name, restaurant_location=r.location) }}" 
                        class="details-btn">
                    <i class="fas fa-info-circle"></i> Details
                  </a>
                  <a href="https://www.google.com/maps/search/?api=1&query={{ (r.name + ' ' + r.location) | urlencode }}" 
                     target="_blank" class="details-btn">
                    <i class="fas fa-map-marker-alt"></i> Maps
                  </a>
                  <a href="{{ r.url }}" target="_blank" class="details-btn">
                    <i class="fab fa-yelp"></i> Yelp
                  </a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No restaurants saved yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Loved Restaurants Sub-tab -->
  <div id="foodies-loved" class="sub-tab-content" style="display: none;">
    <div class="card-section">
      <div class="section-header">
        <!-- Button to clear all loved restaurants -->
        <form method="POST" action="{{ url_for('clear_loved_restaurants') }}">
          <button type="submit" onclick="return confirm('Are you sure you want to clear all loved restaurants?')">Clear All Liked Restaurants</button>
        </form>
      </div>
      {% if loved_restaurants %}
        <div class="card-container">
          {% for r in loved_restaurants %}
            <div class="card restaurant-card">
              <img src="{{ r.image_url }}" alt="Restaurant Image" class="card-img"
                onerror="this.onerror=null;this.src='https://st4.depositphotos.com/14953852/24787/v/450/depositphotos_247872612-stock-illustration-no-image-available-icon-vector.jpg';">
              
              <div class="card-content">
                <strong>{{ r.name }}</strong><br>
                <span class="location"><i class="fas fa-map-marker-alt"></i> {{ r.location }}</span><br>
                <div class="rating-price-inline">
                  <span class="rating">‚≠ê {{ r.rating }}</span>
                  <span class="price">üí≤{{ r.price }}</span>
                  <button class="heart-btn-inline" 
                    data-name="{{ r.name }}"
                    data-location="{{ r.location }}">
                    <i class="fas fa-heart" style="color: red;"></i>
                  </button>
                </div>
                
                <div class="restaurant-actions">
                  <a href="{{ url_for('restaurant_detail', restaurant_name=r.name, restaurant_location=r.location) }}" 
                     class="details-btn">
                    <i class="fas fa-info-circle"></i> Details
                  </a>
                  <a href="https://www.google.com/maps/search/?api=1&query={{ (r.name + ' ' + r.location) | urlencode }}" 
                     target="_blank" class="details-btn">
                    <i class="fas fa-map-marker-alt"></i> Maps
                  </a>
                  <a href="{{ r.url }}" target="_blank" class="details-btn">
                    <i class="fab fa-yelp"></i> Yelp
                  </a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No liked restaurants yet. ‚ù§Ô∏è Heart some restaurants to see them here!</p>
      {% endif %}
    </div>
  </div>
</div>

  <!-- PrepnGo saved results section -->
<div id="prep" class="main-tab-content" style="display: none;">
  <!-- Sub-tabs for meals -->
  <div class="sub-tab-buttons">
    <button class="sub-tab-button active" onclick="showSubTab('prep', 'search-history')">Search History</button>
    <button class="sub-tab-button" onclick="showSubTab('prep', 'loved')">Liked</button>
  </div>

  <!-- Meal Search History Sub-tab -->
  <div id="prep-search-history" class="sub-tab-content">
    <div class="card-section">
      <div class="section-header">
        <!-- Button to clear all saved PrepnGo results -->
        <form method="POST" action="{{ url_for('clear_prepngo') }}">
          <button type="submit">Clear All Search History</button>
        </form>
      </div>

      {% if prepngo_results %}
        <div class="card-container">
          {% for m in prepngo_results %}
            <div class="card meal-card" data-meal-name="{{ m[0] }}" data-meal-url="{{ m[3] }}" data-meal-title="{{ m[0] }}">
              <div class="card-content">
                <strong>{{ m[0] }}</strong><br>
                  <div class="rating-price-inline">
                    <span class="price">üí∞ ${{ "%.2f"|format(m[1]) }}</span>
                    <button class="heart-btn-inline" onclick="toggleMealLove('{{ m[0] }}', '{{ m[3] }}', this)">
                        {% if m[4] %}
                        <i class="fas fa-heart" style="color: red;"></i>
                        {% else %}
                        <i class="far fa-heart"></i>
                        {% endif %}
                    </button>
                    <button class="delete-btn-inline" 
                        data-title="{{ m[0] }}"
                        title="Delete from search history">
                        <i class="fas fa-trash-alt" style="color: #dc3545;"></i>
                    </button>
                  </div>
                <p class="meal-description">{{ m[2] }}</p>
                <div class="meal-actions">
                    <a href="{{ url_for('meal_detail', title=m[0], source='prep-search-history') }}" class="details-btn">
                        <i class="fas fa-info-circle"></i> Details
                    </a>
                    <a href="{{ m[3] }}" target="_blank" class="details-btn">
                        <i class="fas fa-external-link-alt"></i> View Recipe
                    </a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No meals saved yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Loved Meals Sub-tab -->
  <div id="prep-loved" class="sub-tab-content" style="display: none;">
    <div class="card-section">
      <div class="section-header">
        <!-- Button to clear all loved meals -->
        <form method="POST" action="{{ url_for('clear_loved_meals') }}">
          <button type="submit" onclick="return confirm('Are you sure you want to clear all loved meals?')">Clear All Liked Meals</button>
        </form>
      </div>
      {% if loved_meals %}
        <div class="card-container">
          {% for m in loved_meals %}
            <div class="card meal-card" data-meal-name="{{ m[0] }}" data-meal-url="{{ m[3] }}">
              <div class="card-content">
                <strong>{{ m[0] }}</strong><br>
                  <div class="rating-price-inline">
                    <span class="price">üí∞ ${{ "%.2f"|format(m[1]) }}</span>
                    <button class="heart-btn-inline" onclick="toggleMealLove('{{ m[0] }}', '{{ m[3] }}', this)">
                      <i class="fas fa-heart" style="color: red;"></i>
                    </button>
                  </div>
                <p class="meal-description">{{ m[2] }}</p>
                <div class="meal-actions">
                    <a href="{{ url_for('meal_detail', title=m[0], source='prep-loved') }}" class="details-btn">
                        <i class="fas fa-info-circle"></i> Details
                    </a>
                    <a href="{{ m[3] }}" target="_blank" class="details-btn">
                        <i class="fas fa-external-link-alt"></i> View Recipe
                    </a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No liked meals yet. ‚ù§Ô∏è Heart some meals to see them here!</p>
      {% endif %}
    </div>
  </div>
</div>

  <!-- Functions to toggle between main tabs and sub-tabs -->
<script>
function showMainTab(tabId) {
    // Hide all main tab content sections
    document.querySelectorAll('.main-tab-content').forEach(el => el.style.display = 'none');
    // Show selected main tab
    document.getElementById(tabId).style.display = 'block';

    // Update main tab button styles
    document.querySelectorAll('.main-tab-button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function showSubTab(mainTab, subTab) {
    document.querySelectorAll(`#${mainTab} .sub-tab-content`).forEach(el => el.style.display = 'none');
    document.getElementById(`${mainTab}-${subTab}`).style.display = 'block';

    document.querySelectorAll(`#${mainTab} .sub-tab-button`).forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Reload the liked tab when switching to it
    if (mainTab === 'foodies' && subTab === 'loved') {
        reloadLovedTab();
    }
}

// Event delegation for all buttons - this handles heart buttons and delete buttons
document.addEventListener('click', function(e) {
    // Handle restaurant love buttons
    if (e.target.closest('.heart-btn-inline')) {
        e.preventDefault();
        const button = e.target.closest('.heart-btn-inline');
        const name = button.getAttribute('data-name');
        const location = button.getAttribute('data-location');
        
        if (name && location) {
            toggleRestaurantLove(name, location, button);
        }
    }
    
    // Handle restaurant delete buttons
    if (e.target.closest('.delete-btn-inline') && e.target.closest('.restaurant-card')) {
        e.preventDefault();
        const button = e.target.closest('.delete-btn-inline');
        const name = button.getAttribute('data-name');
        const location = button.getAttribute('data-location');
        
        if (name && location) {
            if (confirm(`Are you sure you want to delete "${name}" from your search history?`)) {
                deleteRestaurant(name, location, button);
            }
        }
    }
    
    // Handle meal delete buttons
    if (e.target.closest('.delete-btn-inline') && e.target.closest('.meal-card')) {
        e.preventDefault();
        const button = e.target.closest('.delete-btn-inline');
        const title = button.getAttribute('data-title');
        
        if (title) {
            if (confirm(`Are you sure you want to delete "${title}" from your search history?`)) {
                deleteMeal(title, button);
            }
        }
    }
});

function deleteRestaurant(name, location, button) {
    console.log('Deleting restaurant:', name, 'at', location);
    
    // Visual feedback
    const card = button.closest('.restaurant-card');
    card.style.opacity = '0.5';
    button.disabled = true;
    
    fetch('/delete_restaurant', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, location: location })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the card from the DOM
            card.remove();
            console.log('Restaurant deleted successfully');
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete restaurant. Please try again.');
        // Restore card appearance
        card.style.opacity = '1';
        button.disabled = false;
    });
}

function deleteMeal(title, button) {
    console.log('Deleting meal:', title);
    
    // Visual feedback
    const card = button.closest('.meal-card');
    card.style.opacity = '0.5';
    button.disabled = true;
    
    fetch('/delete_meal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: title })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the card from search history
            card.remove();
            
            // Also remove from loved tab if it exists there
            const lovedTabContainer = document.getElementById('prep-loved').querySelector('.card-container');
            const lovedCards = lovedTabContainer.querySelectorAll('.meal-card');
            lovedCards.forEach(lovedCard => {
                const cardTitle = lovedCard.getAttribute('data-meal-name');
                if (cardTitle === title) {
                    lovedCard.remove();
                }
            });
            
            // Check if loved tab is now empty and show appropriate message
            const remainingLovedCards = lovedTabContainer.querySelectorAll('.meal-card');
            if (remainingLovedCards.length === 0) {
                lovedTabContainer.innerHTML = "<p>No liked meals yet. ‚ù§Ô∏è Heart some meals to see them here!</p>";
            }
            
            console.log('Meal deleted successfully from both tabs');
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete meal. Please try again.');
        // Restore card appearance
        card.style.opacity = '1';
        button.disabled = false;
    });
}

function toggleRestaurantLove(name, location, button) {
    console.log('Toggling love for:', name, 'at', location);
    
    // Visual feedback
    button.style.opacity = '0.5';
    button.disabled = true;
    
    fetch('/love_restaurant', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, location: location })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Server response:', data);
        
        // Update ALL heart buttons for this restaurant across the entire page
        updateAllRestaurantHearts(name, location, data.loved);
        
        // Handle loved tab synchronization
        reloadLovedTab();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update favorite. Please try again.');
    })
    .finally(() => {
        button.style.opacity = '1';
        button.disabled = false;
    });
}

function updateAllRestaurantHearts(name, location, isLoved) {
    // Find all heart buttons for this restaurant
    const allHeartButtons = document.querySelectorAll('.heart-btn-inline');
    
    allHeartButtons.forEach(heartBtn => {
        const btnName = heartBtn.getAttribute('data-name');
        const btnLocation = heartBtn.getAttribute('data-location');
        
        if (btnName === name && btnLocation === location) {
            if (isLoved) {
                heartBtn.innerHTML = '<i class="fas fa-heart" style="color: red;"></i>';
            } else {
                heartBtn.innerHTML = '<i class="far fa-heart"></i>';
            }
        }
    });
}

function reloadLovedTab() {
    const lovedTabContainer = document.getElementById('foodies-loved').querySelector('.card-container');
    lovedTabContainer.innerHTML = "<p>Loading...</p>"; // optional loading state

    fetch('/get_loved_restaurants')
        .then(response => response.json())
        .then(data => {
            lovedTabContainer.innerHTML = ''; // clear current cards

            if (!data.restaurants || data.restaurants.length === 0) {
                lovedTabContainer.innerHTML = "<p>No loved restaurants yet. ‚ù§Ô∏è Heart some restaurants to see them here!</p>";
                return;
            }

            data.restaurants.forEach(r => {
                const card = document.createElement('div');
                card.className = 'card restaurant-card';
                card.innerHTML = `
                  <img src="${r.image_url}" alt="Restaurant Image" class="card-img"
                    onerror="this.onerror=null;this.src='https://st4.depositphotos.com/14953852/24787/v/450/depositphotos_247872612-stock-illustration-no-image-available-icon-vector.jpg';">
                  <div class="card-content">
                    <strong>${r.name}</strong><br>
                    <span class="location"><i class="fas fa-map-marker-alt"></i> ${r.location}</span><br>
                    <div class="rating-price-inline">
                        <span class="rating">‚≠ê ${r.rating}</span>
                        <span class="price">üí≤${r.price}</span>
                        <button class="heart-btn-inline" data-name="${r.name}" data-location="${r.location}">
                            <i class="fas fa-heart" style="color: red;"></i>
                        </button>
                    </div>
                    <div class="restaurant-actions">
                        <a href="/restaurant/${encodeURIComponent(r.name)}/${encodeURIComponent(r.location)}" class="details-btn">
                          <i class="fas fa-info-circle"></i> Details
                        </a>
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name + ' ' + r.location)}" target="_blank" class="details-btn">
                          <i class="fas fa-map-marker-alt"></i> Maps
                        </a>
                        <a href="${r.url}" target="_blank" class="details-btn">
                          <i class="fab fa-yelp"></i> Yelp
                        </a>
                    </div>
                  </div>
                `;
                lovedTabContainer.appendChild(card);
            });
        })
        .catch(error => {
            lovedTabContainer.innerHTML = "<p>Error loading liked restaurants.</p>";
            console.error('Error fetching loved tab data:', error);
        });
}

// Keep the meal love function as is for now
function toggleMealLove(name, url, button) {
    fetch('/love_meal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            url: url
        })
    })
    .then(response => response.json())
    .then(data => {
        // Update ALL heart buttons for this meal across both tabs
        const allMealCards = document.querySelectorAll('.meal-card');
        allMealCards.forEach(card => {
            const cardName = card.getAttribute('data-meal-name');
            const cardUrl = card.getAttribute('data-meal-url');
            const heartBtn = card.querySelector('.heart-btn-inline');

            if (cardName === name && cardUrl === url && heartBtn) {
                if (data.loved) {
                    heartBtn.innerHTML = '<i class="fas fa-heart" style="color: red;"></i>';
                } else {
                    heartBtn.innerHTML = '<i class="far fa-heart"></i>';
                }
            }
        });

        // Handle loved meals tab
        const lovedTabContainer = document.getElementById('prep-loved').querySelector('.card-container');
        
        if (data.loved) {
            const originalCard = button.closest('.card');
            const alreadyExists = Array.from(lovedTabContainer.children).some(card =>
                card.getAttribute('data-meal-name') === name &&
                card.getAttribute('data-meal-url') === url
            );

            if (!alreadyExists) {
                const clonedCard = originalCard.cloneNode(true);
                
                // Remove delete button from cloned card (loved tab shouldn't have delete buttons)
                const deleteBtn = clonedCard.querySelector('.delete-btn-inline');
                if (deleteBtn) {
                    deleteBtn.remove();
                }
                
                lovedTabContainer.appendChild(clonedCard);
            }
        } else {
            const cards = lovedTabContainer.querySelectorAll('.meal-card');
            cards.forEach(card => {
                if (card.getAttribute('data-meal-name') === name && 
                    card.getAttribute('data-meal-url') === url) {
                    lovedTabContainer.removeChild(card);
                }
            });
        }
    })
    .catch(error => {
        console.error('Error toggling meal love:', error);
    });
}

// Handle hash-based navigation on page load
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash.substring(1); // Remove the #
    
    if (hash === 'prep-search-history') {
        // Show meals tab and search history
        activateMainTab('prep');
        activateSubTab('prep', 'search-history');
    } else if (hash === 'prep-loved') {
        // Show meals tab and loved meals
        activateMainTab('prep');
        activateSubTab('prep', 'loved');
    }
    
    // Clear the hash after processing
    if (hash.startsWith('prep-')) {
        history.replaceState(null, null, window.location.pathname);
    }
});

// Helper functions that don't rely on event object
function activateMainTab(tabId) {
    document.querySelectorAll('.main-tab-content').forEach(el => el.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
    document.querySelectorAll('.main-tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="showMainTab('${tabId}')"]`).classList.add('active');
}

function activateSubTab(mainTab, subTab) {
    document.querySelectorAll(`#${mainTab} .sub-tab-content`).forEach(el => el.style.display = 'none');
    document.getElementById(`${mainTab}-${subTab}`).style.display = 'block';
    document.querySelectorAll(`#${mainTab} .sub-tab-button`).forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="showSubTab('${mainTab}', '${subTab}')"]`).classList.add('active');
}
</script>
    
{% endblock %}