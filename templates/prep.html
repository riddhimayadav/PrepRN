{% extends "layout.html" %}

{% block head %}
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='prep.css') }}"
  >
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  >
{% endblock %}

{% block content %}
<main>
  <div class="eatin-wrapper">
    <h2>Find Your Next Favorite Recipe</h2>

    <form
      id="eat-in-form"
      class="eatin-form"
      method="POST"
      action="{{ url_for('prep') }}"
      onsubmit="return showLoading(event)"
    >

      <!-- Location with GPS -->
      <div class="input-group">
        <label><i class="fas fa-map-marker-alt"></i> Location:</label>
        <div class="location-controls">
          <button type="button" class="location-btn default" id="gpsBtn" onclick="getLocation()">
            <i class="fas fa-location-arrow"></i> Use My Current Location
          </button>
          <div class="or-divider">or</div>
          <input type="text" id="locationInput" name="location" 
                 placeholder="Enter address, city, or zip code" 
                 value="{{ request.form.location if request.form.location }}"
                 required>
        </div>
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">
      </div>

      <!-- Grocery or Pantry Option -->
    <div class="input-group radio-group">
        <label class="radio-header">
            <i class="fas fa-shopping-cart"></i>
            Do You Want to Grocery Shop For This Meal?
        </label>

        <label class="radio-option">
            <input type="radio" name="grocery" value="yes" required>
            Yes
        </label>

        <label class="radio-option">
            <input type="radio" name="grocery" value="no">
            No (only use ingredients from my pantry)
        </label>
    </div>
      <!-- Budget (only shown when grocery=yes) -->
      <div class="input-group" id="budget-group" style="display: none;">
        <label><i class="fas fa-wallet"></i> Budget For Today's Meal:</label>
        <input
          type="number"
          step="0.01"
          name="budget"
          placeholder="$0.00"
          id="budget-input"
        >

      </div>

      <!-- no -> pantry‚Äëonly section -->
      <div class="input-group" id="pantry-group" style="display:none;">
        <label><i class="fas fa-boxes"></i> Pantry Items Available:</label>
        {% if pantry_items %}
      <ul class="pantry-list">
        {% for item in pantry_items %}
          <li>{{ item }}</li>
        {% endfor %}
      </ul>
        {% else %}
          <div class="empty-field" style="text-align: center;"><em>Your pantry is empty.</em></div>
        {% endif %}
        <p style="margin-top:0.5rem; text-align: center;">
          <a href="{{ url_for('dashboard') }}" class="dashboard-btn">Go to Dashboard to edit your pantry ‚Üí</a>
        </p>
      </div>

      <!-- Servings -->
      <div class="input-group">
        <label><i class="fas fa-users"></i> Servings:</label>
        <input
          type="number"
          name="servings"
          min="1"
          placeholder="e.g. 2"
          required
        >
      </div>

      <!-- Meal Type -->
      <div class="input-group">
        <label><i class="fas fa-utensils"></i> Meal Type:</label>
        <select name="meal_type">
          <option value="">Any</option>
          <option>Breakfast</option>
          <option>Lunch</option>
          <option>Dinner</option>
          <option>Snack</option>
          <option>Dessert</option>
          <option>Smoothie</option>
          <option>Salad</option>
          <option>Soup</option>
          <option>Sandwich</option>
        </select>
      </div>

      <!-- Dietary Restrictions (pulled from dashboard) -->
      <div class="input-group">
        <label><i class="fas fa-apple-alt"></i> Dietary Restrictions:</label>
        {% if restrictions %}
          <ul class="pantry-list">
            {% for restriction in restrictions %}
              <li>{{ restriction }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty-field" style="text-align: center;"><em>No dietary restrictions set.</em></div>
        {% endif %}
        <p style="margin-top:0.5rem; text-align: center;">
          <a href="{{ url_for('dashboard') }}" class="dashboard-btn">Go to Dashboard to edit your restrictions ‚Üí</a>
        </p>
      </div>

      <!-- Submit -->
      <button type="submit">Continue</button>
    </form>

    <!-- Loading message -->
    <div id="loading-msg" style="display:none;">
      <p>‚è≥ Generating your meal plan‚Ä¶</p>
    </div>

    
{% if results %}
  <br><br>
  <h3 id="recommendations">ü•ó Your Meal Plan</h3>
  <div class="recommendation-wrapper">
    {% for m in results['meals'] %}
    <div class="recommendation">
      <div class="restaurant-content">
        <h4>{{ m['title'] }}</h4>
        <div class="rating-price-inline">
          <span class="price">üí∞ ${{ "%.2f"|format(m['price']) }}</span>
          <button class="heart-btn-inline"
            data-name="{{ m['title'] }}"
            data-url="{{ m['source_url'] }}">
            {% if m.get('loved') %}
              <i class="fas fa-heart" style="color:red"></i>
            {% else %}
              <i class="far fa-heart"></i>
            {% endif %}
          </button>
        </div>
        <!-- summary or blurb -->
        <p>{{ m['summary'] }}</p>
        <div class="restaurant-actions">
          <div class="action-buttons">
            <a href="{{ m['source_url'] }}" target="_blank">
              <i class="fas fa-external-link-alt"></i> View Recipe
            </a>
            <a href="{{ url_for('meal_detail', title=m['title']) }}">
              <i class="fas fa-info-circle"></i> Details
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <h3>üõí Your Grocery Store Recommendations</h3>
  <ul class="store-list">
  {% for item in results['stores'].split('\n') %}
    {% set clean = item.lstrip('- ') %}
    {% if clean %}
      {# split at the first ": " #}
      {% set name, sep, desc = clean.partition(': ') %}
      <li>
        <strong>{{ name }}</strong>{{ sep }}{{ desc }}
      </li>
    {% endif %}
  {% endfor %}
</ul>
{% endif %}
  </div>
</main>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Show loading spinner and delay submit
    window.showLoading = function(e) {
      e.preventDefault();
      document.getElementById("loading-msg").style.display = "block";
      document.getElementById("eat-in-form").style.opacity = "0.5";
      setTimeout(() => document.getElementById("eat-in-form").submit(), 100);
      return false;
    };

    // 2) Scroll to recommendations if present
    const rec = document.getElementById("recommendations");
    if (rec) rec.scrollIntoView({ behavior: "smooth" });

    // 3) Toggle budget/pantry view
    document.querySelectorAll('input[name="grocery"]').forEach(radio => {
      radio.addEventListener('change', e => {
        const groceryYes = e.target.value === 'yes';
        document.getElementById('budget-group').style.display = groceryYes ? 'block' : 'none';
        document.getElementById('pantry-group').style.display = groceryYes ? 'none' : 'block';
        if (!groceryYes) {
          document.getElementById('budget-input').value = '';
        }
      });
    });
  });

  // 4) Get GPS location
  let locationFound = false;

  function getLocation() {
    const gpsBtn = document.getElementById('gpsBtn');
    const locationInput = document.getElementById('locationInput');

    gpsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
    gpsBtn.disabled = true;
    gpsBtn.style.backgroundColor = '#ACB288';
    gpsBtn.style.color = 'white';
    gpsBtn.style.pointerEvents = 'none';

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;

          document.getElementById('latitude').value = latitude;
          document.getElementById('longitude').value = longitude;
          locationInput.value = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
          locationInput.placeholder = 'GPS location found';

          locationFound = true;
          gpsBtn.innerHTML = '<i class="fas fa-check"></i> Location Found!';
          gpsBtn.style.backgroundColor = '#ACB288';
          gpsBtn.style.color = 'white';
          gpsBtn.style.pointerEvents = 'none';
          gpsBtn.disabled = false;
        },
        function(error) {
          console.error('GPS Error:', error);
          gpsBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> GPS Unavailable';
          gpsBtn.style.backgroundColor = '#FB4141';
          gpsBtn.style.color = 'white';
          gpsBtn.style.pointerEvents = 'auto';
          gpsBtn.disabled = false;

          alert('Unable to get your location. Please enter your address manually.');
          locationInput.focus();
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000
        }
      );
    } else {
      gpsBtn.innerHTML = '<i class="fas fa-times"></i> Not Supported';
      gpsBtn.style.backgroundColor = '#FB4141';
      gpsBtn.style.color = 'white';
      gpsBtn.style.pointerEvents = 'none';
      alert('Your browser does not support location services. Please enter your address manually.');
      locationInput.focus();
    }
  }

  // 5) Clear GPS data when location input changes
  document.getElementById('locationInput').addEventListener('input', function() {
    if (locationFound || document.getElementById('latitude').value) {
      document.getElementById('latitude').value = '';
      document.getElementById('longitude').value = '';
      locationFound = false;

      const gpsBtn = document.getElementById('gpsBtn');
      gpsBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use My Current Location';
      gpsBtn.style.backgroundColor = '';
      gpsBtn.style.color = '';
      gpsBtn.style.pointerEvents = 'auto';
      gpsBtn.disabled = false;

      this.placeholder = 'Enter address, city, or zip code';
    }
  });

  // 6) Toggle loved state on heart click (event delegation)
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.heart-btn-inline');
    if (btn && btn.hasAttribute('data-name') && btn.hasAttribute('data-url')) {
      e.preventDefault();
      const name = btn.getAttribute('data-name');
      const url = btn.getAttribute('data-url');
      toggleMealLove(name, url, btn);
    }
  });

  // 7) Reusable AJAX heart toggle function
  function toggleMealLove(name, url, button) {
    fetch('/love_meal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, url })
    })
    .then(res => res.json())
    .then(data => {
      button.innerHTML = data.loved
        ? '<i class="fas fa-heart" style="color: red;"></i>'
        : '<i class="far fa-heart"></i>';
    })
    .catch(err => {
      console.error('Error:', err);
      alert('Failed to save favorite. Please try again.');
    });
  }
</script>

{% endblock %}