{% extends "layout.html" %}

{% block head %}
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='prep.css') }}"
  >
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  >
{% endblock %}

{% block content %}
<main>
  <div class="eatin-wrapper">
    <h2>Find Your Next Favorite Recipe</h2>

    <form
      id="eat-in-form"
      class="eatin-form"
      method="POST"
      action="{{ url_for('prep') }}"
      onsubmit="return showLoading(event)"
    >
      <!-- Location -->
      <div class="input-group">
        <label><i class="fas fa-map-marker-alt"></i> Location:</label>
        <input
          type="text"
          name="location"
          placeholder="e.g. Austin, TX"
          required
        >
      </div>

      <!-- Grocery or Pantry Option -->
    <div class="input-group radio-group">
        <label class="radio-header">
            <i class="fas fa-shopping-cart"></i>
            Do You Want to Grocery Shop For This Meal?
        </label>

        <label class="radio-option">
            <input type="radio" name="grocery" value="yes" required>
            Yes
        </label>

        <label class="radio-option">
            <input type="radio" name="grocery" value="no">
            No (only use ingredients from my pantry)
        </label>
    </div>
      <!-- Budget (only shown when grocery=yes) -->
      <div class="input-group" id="budget-group" style="display: none;">
        <label><i class="fas fa-wallet"></i> Budget For Today's Meal:</label>
        <input
          type="number"
          step="0.01"
          name="budget"
          placeholder="$0.00"
          id="budget-input"
          required
        >
      </div>

      <!-- no -> pantry‚Äëonly section -->
      <div class="input-group" id="pantry-group" style="display:none;">
        <label><i class="fas fa-boxes"></i> Pantry Items Available:</label>
        {% if pantry_items %}
      <ul class="pantry-list">
        {% for item in pantry_items %}
          <li>{{ item }}</li>
        {% endfor %}
      </ul>
        {% else %}
          <p><em>Your pantry is empty.</em></p>
        {% endif %}
        <p style="margin-top:0.5rem;">
          <a href="{{ url_for('dashboard') }}">Go to Dashboard to edit your pantry ‚Üí</a>
        </p>
      </div>

      <!-- Servings -->
      <div class="input-group">
        <label><i class="fas fa-users"></i> Servings:</label>
        <input
          type="number"
          name="servings"
          min="1"
          placeholder="e.g. 2"
          required
        >
      </div>

      <!-- Meal Type -->
      <div class="input-group">
        <label><i class="fas fa-utensils"></i> Meal Type:</label>
        <select name="meal_type">
          <option value="">Any</option>
          <option>Breakfast</option>
          <option>Lunch</option>
          <option>Dinner</option>
          <option>Snack</option>
          <option>Dessert</option>
          <option>Smoothie</option>
          <option>Salad</option>
          <option>Soup</option>
          <option>Sandwich</option>
        </select>
      </div>

      <!-- Dietary Restrictions (pulled from dashboard) -->
      <div class="input-group">
        <label><i class="fas fa-apple-alt"></i> Dietary Restrictions:</label>
        <div class="saved-restrictions">
          {% if restrictions %}
            {{ restrictions | join(', ') }}
          {% else %}
            <em>None set. You can update these on your
              <a href="{{ url_for('dashboard') }}">Dashboard</a>.
            </em>
          {% endif %}
        </div>
      </div>

      <!-- Submit -->
      <button type="submit">Continue</button>
    </form>

    <!-- Loading message -->
    <div id="loading-msg" style="display:none;">
      <p>‚è≥ Generating your meal plan‚Ä¶</p>
    </div>

    
{% if results %}
  <br><br>
  <h3 id="recommendations">ü•ó Your Meal Plan</h3>
  <div class="recommendation-wrapper">
    {% for m in results['meals'] %}
    <div class="recommendation">
      <div class="restaurant-content">
        <h4>{{ m['title'] }}</h4>
        <div class="rating-price-inline">
          <span class="price">üí∞ ${{ "%.2f"|format(m['price']) }}</span>
          <button class="heart-btn-inline"
                  onclick="toggleMealLove('{{ m['title'] }}','{{ m['source_url'] }}', this)">
            {% if m.get('loved') %}
              <i class="fas fa-heart" style="color:red"></i>
            {% else %}
              <i class="far fa-heart"></i>
            {% endif %}
          </button>
        </div>
        <!-- summary or blurb -->
        <p>{{ m['summary'] }}</p>
        <div class="restaurant-actions">
          <div class="action-buttons">
            <a href="{{ m['source_url'] }}" target="_blank">
              <i class="fas fa-external-link-alt"></i> View Recipe
            </a>
            <a href="{{ url_for('meal_detail', title=m['title']) }}">
              <i class="fas fa-info-circle"></i> Details
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <h3>üõí Your Grocery Store List</h3>
  <ul class="store-list">
  {% for item in results['stores'].split('\n') %}
    {% set clean = item.lstrip('- ') %}
    {% if clean %}
      {# split at the first ‚Äú: ‚Äù #}
      {% set name, sep, desc = clean.partition(': ') %}
      <li>
        <strong>{{ name }}</strong>{{ sep }}{{ desc }}
      </li>
    {% endif %}
  {% endfor %}
</ul>
{% endif %}
  </div>
</main>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) show‚Äêloading helper (called via onsubmit="return showLoading(event)")
    window.showLoading = function(e) {
      e.preventDefault();
      document.getElementById("loading-msg").style.display = "block";
      document.getElementById("eat-in-form").style.opacity = "0.5";
      setTimeout(() => e.target.submit(), 100);
      return false;
    };

    // 2) if we‚Äôve got recommendations, scroll them into view
    const rec = document.getElementById("recommendations");
    if (rec) rec.scrollIntoView({ behavior: "smooth" });

    // 3) when grocery‚Äëradio changes, toggle budget vs pantry
    document.querySelectorAll('input[name="grocery"]').forEach(radio => {
      radio.addEventListener('change', e => {
        const groceryYes = e.target.value === 'yes';
        // show budget input only if ‚Äúyes‚Äù
        document.getElementById('budget-group').style.display = groceryYes ? 'block' : 'none';
        // show pantry list only if ‚Äúno‚Äù
        document.getElementById('pantry-group').style.display = groceryYes ? 'none' : 'block';
        // clear any leftover budget if hiding
        if (!groceryYes) {
          document.getElementById('budget-input').value = '';
        }
      });
    });
  });


  // 4) AJAX toggle for ‚Äúlove‚Äù heart on each meal
  function toggleMealLove(name, url, button) {
    fetch('/love_meal', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ name, url })
    })
    .then(r => r.json())
    .then(data => {
      button.innerHTML = data.loved
        ? '<i class="fas fa-heart" style="color: red;"></i>'
        : '<i class="far fa-heart"></i>';
    })
    .catch(console.error);
  }
</script>
{% endblock %}